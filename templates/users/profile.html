{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/profile.css' %}">
{% endblock %}

{% block content %}
<div class="user-profile-container">
    <!-- 个人信息部分 -->
    <div class="profile-section">
        <div class="profile-header">
            <h2>个人信息</h2>
            <a href="#" class="edit-btn" id="editProfileBtn">编辑资料</a>
        </div>
        
        <div class="profile-content">
            <div class="avatar-section">
                {% if user.avatar %}
                <img src="{{ user.avatar.url }}" alt="用户头像" class="user-avatar">
                {% else %}
                <div class="default-avatar">
                    <i class="fas fa-user"></i>
                </div>
                {% endif %}
            </div>
            
            <div class="profile-details">
                <div class="detail-item">
                    <span class="detail-label">用户名</span>
                    <span class="detail-value">{{ user.username }}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">电子邮箱</span>
                    <span class="detail-value">{{ user.email|default:"未填写" }}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">手机号码</span>
                    <span class="detail-value">{{ user.phone|default:"未填写" }}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">注册时间</span>
                    <span class="detail-value">{{ user.date_joined|date:"Y-m-d H:i" }}</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 领养记录部分 -->
    <div class="adoption-section">
        <h2>我的领养记录</h2>
        
        <div class="tabs">
            <div class="tab-header">
                <button class="tab-button active" data-tab="pending">
                    <i class="fas fa-clock"></i> 待审核申请
                </button>
                <button class="tab-button" data-tab="approved">
                    <i class="fas fa-check-circle"></i> 已通过申请
                </button>
                <button class="tab-button" data-tab="rejected">
                    <i class="fas fa-times-circle"></i> 未通过申请
                </button>
            </div>
            
            <div class="tab-content">
                <!-- 待审核申请 -->
                <div class="tab-panel active" id="pending-tab">
                    {% if pending_applications %}
                        {% for application in pending_applications %}
                        <div class="adoption-card">
                            <div class="pet-image">
                                <img src="{{ application.pet.photo.url }}" alt="{{ application.pet.name }}">
                            </div>
                            <div class="adoption-info">
                                <h3>{{ application.pet.name }}</h3>
                                <p><span>品种：</span>{{ application.pet.breed }}</p>
                                <p><span>申请时间：</span>{{ application.apply_date|date:"Y-m-d" }}</p>
                                <div class="status pending">审核中</div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-state">
                            <i class="fas fa-inbox"></i>
                            <p>暂无待审核的申请</p>
                        </div>
                    {% endif %}
                </div>
                
                <!-- 已通过申请 -->
                <div class="tab-panel" id="approved-tab">
                    {% if approved_applications %}
                        {% for application in approved_applications %}
                        <div class="adoption-card">
                            <div class="pet-image">
                                <img src="{{ application.pet.photo.url }}" alt="{{ application.pet.name }}">
                            </div>
                            <div class="adoption-info">
                                <h3>{{ application.pet.name }}</h3>
                                <p><span>品种：</span>{{ application.pet.breed }}</p>
                                <p><span>领养时间：</span>{{ application.approve_date|date:"Y-m-d" }}</p>
                                <div class="status approved">已领养</div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-state">
                            <i class="fas fa-inbox"></i>
                            <p>暂无已通过的申请</p>
                        </div>
                    {% endif %}
                </div>
                
                <!-- 未通过申请 -->
                <div class="tab-panel" id="rejected-tab">
                    {% if rejected_applications %}
                        {% for application in rejected_applications %}
                        <div class="adoption-card">
                            <div class="pet-image">
                                <img src="{{ application.pet.photo.url }}" alt="{{ application.pet.name }}">
                            </div>
                            <div class="adoption-info">
                                <h3>{{ application.pet.name }}</h3>
                                <p><span>品种：</span>{{ application.pet.breed }}</p>
                                <p><span>申请时间：</span>{{ application.apply_date|date:"Y-m-d" }}</p>
                                <p class="reject-reason"><span>未通过原因：</span>{{ application.reject_reason }}</p>
                                <div class="status rejected">未通过</div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-state">
                            <i class="fas fa-inbox"></i>
                            <p>暂无未通过的申请</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 添加编辑个人信息的模态框 -->
<div id="editProfileModal" class="modal">
    <div class="modal-content">
        <span class="close-modal">&times;</span>
        <h3>编辑个人信息</h3>
        <form method="post" action="/users/update-profile/" enctype="multipart/form-data">
            {% csrf_token %}
            <!-- 在模态框表单中 -->
            <div class="form-group">
                <label for="username">用户名</label>
                <input type="text" id="username" name="username" value="{{ user.username }}">
                <small>更改用户名后需要使用新用户名登录</small>
            </div>
            <div class="form-group">
                <label for="email">电子邮箱</label>
                <input type="email" id="email" name="email" value="{{ user.email|default:'' }}">
            </div>
            <div class="form-group">
                <label for="phone">手机号码</label>
                <input type="tel" id="phone" name="phone" value="{{ user.phone|default:'' }}">
            </div>
            <div class="form-group">
                <label for="avatar">头像</label>
                <input type="file" id="avatar" name="avatar" accept="image/*">
                <small>选择新图片上传，不选则保持原头像</small>
            </div>
            <div class="form-actions">
                <button type="submit" class="submit-btn">保存修改</button>
                <button type="button" class="cancel-btn" id="cancelEditBtn">取消</button>
            </div>
        </form>
    </div>
</div>

<script>
    // 标签页切换功能
    document.addEventListener('DOMContentLoaded', function() {
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabPanels = document.querySelectorAll('.tab-panel');
        
        tabButtons.forEach(button => {
            button.addEventListener('click', function() {
                // 移除所有按钮的active类
                tabButtons.forEach(btn => btn.classList.remove('active'));
                // 给当前点击的按钮添加active类
                this.classList.add('active');
                
                // 获取对应的标签面板ID
                const tabId = this.getAttribute('data-tab') + '-tab';
                
                // 隐藏所有标签面板
                tabPanels.forEach(panel => panel.classList.remove('active'));
                // 显示当前标签面板
                document.getElementById(tabId).classList.add('active');
            });
        });
        
        // 编辑个人信息模态框功能
        const modal = document.getElementById('editProfileModal');
        const editBtn = document.getElementById('editProfileBtn');
        const closeBtn = document.querySelector('.close-modal');
        const cancelBtn = document.getElementById('cancelEditBtn');
        
        // 打开模态框
        editBtn.addEventListener('click', function(e) {
            e.preventDefault();
            modal.style.display = 'block';
        });
        
        // 关闭模态框的多种方式
        closeBtn.addEventListener('click', function() {
            modal.style.display = 'none';
        });
        
        cancelBtn.addEventListener('click', function() {
            modal.style.display = 'none';
        });
        
        // 点击模态框外部关闭
        window.addEventListener('click', function(event) {
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        });
    });
</script>
{% endblock %}


